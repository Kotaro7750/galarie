services:
  devcontainer:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
      args:
        NODE_MAJOR: "24"
        NODE_FALLBACK: "22"
    command: /bin/sh -c "while sleep 1000; do :; done"
    volumes:
      - ..:/workspaces/galarie
      - ../media:/workspace/media:cached
    environment:
      GALARIE_MEDIA_ROOT: /workspace/media
      GALARIE_CACHE_DIR: /workspace/.cache
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    ports:
      - "8080:8080"
      - "5173:5173"
    depends_on:
      - otel-collector

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.104.0
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml:ro

  prometheus:
    image: prom/prometheus:v3.0.0
    command: 
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=24h"
      - "--web.enable-otlp-receiver"
    tmpfs:
      # This permission setting is required for avoiding following error
      # "Failed to create directory for logging active queries" component=activeQueryTracker
      - /prometheus:rw,mode=777
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro

  loki:
    image: grafana/loki:3.5.7
    command: ["-config.file=/etc/loki/config.yml"]
    volumes:
      - ./observability/loki/config.yml:/etc/loki/config.yml:ro
    tmpfs:
      # This permission setting is required for avoiding error on startup
      - /tmp/loki:rw,mode=777

  tempo:
    image: grafana/tempo:2.4.1
    command: ["-config.file=/etc/tempo/tempo.yaml"]
    tmpfs:
      - /tmp/tempo:rw,mode=777
    volumes:
      - ./observability/tempo/tempo.yaml:/etc/tempo/tempo.yaml:ro

  grafana:
    image: grafana/grafana:12.2.1
    depends_on:
      - prometheus
      - loki
      - tempo
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_BASIC_ENABLED=false
    tmpfs:
      - /var/lib/grafana:rw,mode=777
    volumes:
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    ports:
      - "3300:3000"

  swaggerui:
    image: swaggerapi/swagger-ui:v5.30.2
    environment:
      SWAGGER_JSON: /specs/openapi.yaml
    volumes:
      - ../specs/galarie-media-platform/contracts/openapi.yaml:/specs/openapi.yaml:ro
    ports:
      - "8088:8080"
